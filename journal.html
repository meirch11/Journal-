<!DOCTYPE html><html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Private Journal</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --muted:#2a3646; --text:#e6eefb; --sub:#a7b3c7; --accent:#4da3ff; --danger:#ff5f5f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:linear-gradient(180deg,#0b0f14,#0e141d 30%,#0b0f14);color:var(--text)}
    .wrap{max-width:950px;margin:0 auto;padding:24px}
    .card{background:var(--panel);border:1px solid var(--muted);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:.2em 0 0;font-weight:800;letter-spacing:.3px}
    h2{margin:.6em 0 .4em;font-weight:700;color:var(--sub)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1 1 300px}
    input,textarea,button{background:#0e1420;color:var(--text);border:1px solid var(--muted);border-radius:12px;padding:12px;font-size:15px;outline:none}
    input:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(77,163,255,.18)}
    button{cursor:pointer}
    .btn{background:var(--accent);border-color:#2f7bd1;color:#071325;font-weight:700}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-outline{background:transparent;color:var(--text)}
    .btn-danger{background:var(--danger);border-color:#c73e3e;color:#180202}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .entry{background:#0e1420;border:1px solid var(--muted);border-radius:14px;padding:12px;margin:10px 0}
    .entry h3{margin:.2em 0 .4em}
    .entry small{color:var(--sub)}
    .tag{display:inline-block;background:#101826;border:1px solid #2a3a52;color:#b6c6de;border-radius:999px;padding:2px 8px;margin-right:6px;font-size:12px}
    .footer{color:var(--sub);font-size:12px;margin-top:20px}
    .hidden{display:none}
    .right{margin-left:auto}
    .link{color:var(--accent);text-decoration:none}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--muted);background:#0e1420;color:var(--sub)}
    .danger{color:#ffb3b3}
    .success{color:#a5ffcc}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="gate">
      <h1>üîê Private Journal</h1>
      <p style="color:var(--sub);max-width:60ch">Your entries are encrypted in your browser using your password. No account. No server. To use on another device, use <b>Export</b> on one device and <b>Import</b> on the other.</p>
      <div class="row">
        <input class="grow" id="pass" type="password" placeholder="Enter password" autocomplete="current-password" />
        <button class="btn" id="enter">Unlock</button>
      </div>
      <small class="mono" id="gateMsg"></small>
      <details style="margin-top:10px"><summary>How it works (tap)</summary>
        <ul>
          <li>Your password never leaves this page.</li>
          <li>We derive a key (PBKDF2) and encrypt entries with AES‚ÄëGCM in your browser.</li>
          <li>Encrypted data is saved to <b>localStorage</b> under a key based on a hash of your password.</li>
        </ul>
      </details>
    </div><div class="card hidden" id="app">
  <div class="toolbar">
    <h2 style="margin:0">‚úçÔ∏è Journal</h2>
    <span class="pill" id="status">locked</span>
    <span class="right"></span>
    <button class="btn-outline" id="exportBtn">Export</button>
    <label class="btn-outline" style="display:inline-block;cursor:pointer">
      Import <input id="importFile" type="file" accept="application/json" style="display:none"/>
    </label>
    <button class="btn-outline" id="logout">Lock</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input class="grow" id="title" placeholder="Title" />
    <input class="grow" id="tags" placeholder="Tags (comma‚Äëseparated)" />
  </div>
  <textarea id="content" placeholder="Write your thoughts‚Ä¶" rows="12" style="width:100%;margin-top:10px"></textarea>
  <div class="toolbar" style="margin-top:10px">
    <button class="btn" id="save">Save (Ctrl/Cmd+S)</button>
    <button class="btn-outline" id="new">New Entry</button>
    <input id="search" class="grow" placeholder="Search title, tags, or text‚Ä¶" />
    <select id="sort" class="btn-outline">
      <option value="new">Newest first</option>
      <option value="old">Oldest first</option>
      <option value="title">Title A‚ÜíZ</option>
    </select>
  </div>

  <div id="list"></div>
  <div class="footer">Tip: everything saves to this device. Use <b>Export</b> to move between devices. Shortcut: <span class="mono">Ctrl/Cmd+S</span>.</div>
</div>

  </div><script>
// ====== Small crypto helpers using Web Crypto API ======
const textEnc = new TextEncoder();
const textDec = new TextDecoder();

function sha256(str){
  return crypto.subtle.digest('SHA-256', textEnc.encode(str)).then(buf=>
    Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''));
}

async function deriveKey(password, salt){
  const baseKey = await crypto.subtle.importKey('raw', textEnc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:120000, hash:'SHA-256'}, baseKey, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
}

async function encryptJSON(key, obj){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = textEnc.encode(JSON.stringify(obj));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);
  return {iv: Array.from(iv), ct: Array.from(new Uint8Array(ct))};
}

async function decryptJSON(key, payload){
  const iv = new Uint8Array(payload.iv);
  const ct = new Uint8Array(payload.ct);
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
  return JSON.parse(textDec.decode(pt));
}

// ====== App state ======
let state = {
  passHash: null, // hex sha256 of password
  key: null,      // AES-GCM CryptoKey
  vault: { entries: [], meta: { createdAt: 0, updatedAt: 0, version: 1 } }
};

const els = {
  gate: document.getElementById('gate'),
  gateMsg: document.getElementById('gateMsg'),
  pass: document.getElementById('pass'),
  enter: document.getElementById('enter'),
  app: document.getElementById('app'),
  status: document.getElementById('status'),
  title: document.getElementById('title'),
  tags: document.getElementById('tags'),
  content: document.getElementById('content'),
  save: document.getElementById('save'),
  newBtn: document.getElementById('new'),
  list: document.getElementById('list'),
  search: document.getElementById('search'),
  sort: document.getElementById('sort'),
  exportBtn: document.getElementById('exportBtn'),
  importFile: document.getElementById('importFile'),
  logout: document.getElementById('logout'),
};

function storageKey(passHash){ return `journal.v1.${passHash}`; }

function now(){ return new Date().toISOString(); }

function renderList(){
  const q = els.search.value.trim().toLowerCase();
  let items = [...state.vault.entries];
  if(q){
    items = items.filter(e=> (e.title+" "+e.body+" "+(e.tags||[]).join(',')).toLowerCase().includes(q));
  }
  const sort = els.sort.value;
  if(sort==='new') items.sort((a,b)=> b.updatedAt.localeCompare(a.updatedAt));
  if(sort==='old') items.sort((a,b)=> a.updatedAt.localeCompare(b.updatedAt));
  if(sort==='title') items.sort((a,b)=> (a.title||'').localeCompare(b.title||''));

  els.list.innerHTML = '';
  if(items.length===0){
    const empty = document.createElement('div');
    empty.className='entry';
    empty.innerHTML = '<em>No entries yet.</em>';
    els.list.appendChild(empty);
    return;
  }

  for(const e of items){
    const div = document.createElement('div');
    div.className = 'entry';
    const tags = (e.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join('');
    div.innerHTML = `
      <h3>${escapeHTML(e.title||'(untitled)')}</h3>
      <small>${formatDate(e.updatedAt)} ‚Ä¢ ${e.words||0} words</small>
      <div style="margin:6px 0">${tags}</div>
      <p style="white-space:pre-wrap;color:var(--sub);max-height:7.5em;overflow:hidden">${escapeHTML((e.body||'').slice(0,800))}${(e.body||'').length>800?'‚Ä¶':''}</p>
      <div class="toolbar">
        <button data-id="${e.id}" class="btn-outline openBtn">Open</button>
        <button data-id="${e.id}" class="btn-outline dupBtn">Duplicate</button>
        <button data-id="${e.id}" class="btn-danger delBtn">Delete</button>
        <span class="right"></span>
      </div>
    `;
    els.list.appendChild(div);
  }

  // hook buttons
  els.list.querySelectorAll('.openBtn').forEach(b=>b.onclick=()=>openEntry(b.dataset.id));
  els.list.querySelectorAll('.dupBtn').forEach(b=>b.onclick=()=>duplicateEntry(b.dataset.id));
  els.list.querySelectorAll('.delBtn').forEach(b=>b.onclick=()=>deleteEntry(b.dataset.id));
}

function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function formatDate(iso){ const d=new Date(iso); return d.toLocaleString(); }

function currentDraft(){
  const title = els.title.value.trim();
  const tags = els.tags.value.split(',').map(s=>s.trim()).filter(Boolean);
  const body  = els.content.value;
  const words = body.trim()? body.trim().split(/\s+/).length : 0;
  return {title,tags,body,words};
}

let openId = null;
function openEntry(id){
  const e = state.vault.entries.find(x=>x.id===id);
  if(!e) return;
  openId = id;
  els.title.value = e.title||'';
  els.tags.value = (e.tags||[]).join(', ');
  els.content.value = e.body||'';
}

function newEntry(){
  openId = null;
  els.title.value=''; els.tags.value=''; els.content.value='';
}

function duplicateEntry(id){
  const e = state.vault.entries.find(x=>x.id===id);
  if(!e) return;
  const copy = JSON.parse(JSON.stringify(e));
  copy.id = crypto.randomUUID();
  copy.title = (e.title||'') + ' (copy)';
  copy.createdAt = now();
  copy.updatedAt = now();
  state.vault.entries.unshift(copy);
  persist();
  renderList();
}

function deleteEntry(id){
  if(!confirm('Delete this entry?')) return;
  state.vault.entries = state.vault.entries.filter(x=>x.id!==id);
  if(openId===id) newEntry();
  persist();
  renderList();
}

async function persist(){
  state.vault.meta.updatedAt = now();
  const payload = await encryptJSON(state.key, state.vault);
  localStorage.setItem(storageKey(state.passHash), JSON.stringify({salt: Array.from(salt), payload}));
  els.status.textContent = 'saved ' + new Date().toLocaleTimeString();
}

let salt; // Uint8Array

async function unlock(){
  els.enter.disabled = true; els.gateMsg.textContent = '';
  const password = els.pass.value;
  if(!password){ els.gateMsg.textContent='Enter a password.'; els.enter.disabled=false; return; }
  state.passHash = await sha256(password);
  // load existing vault if any
  const raw = localStorage.getItem(storageKey(state.passHash));

  if(raw){
    try{
      const blob = JSON.parse(raw);
      salt = new Uint8Array(blob.salt);
      state.key = await deriveKey(password, salt);
      state.vault = await decryptJSON(state.key, blob.payload);
      afterUnlock();
      return;
    }catch(err){
      els.gateMsg.textContent='Wrong password for this device/journal.';
      els.enter.disabled=false; return;
    }
  } else {
    // First time: create new vault with fresh salt
    salt = crypto.getRandomValues(new Uint8Array(16));
    state.key = await deriveKey(password, salt);
    state.vault = { entries: [], meta: { createdAt: now(), updatedAt: now(), version: 1 } };
    await persist();
    afterUnlock();
  }
}

function afterUnlock(){
  els.gate.classList.add('hidden');
  els.app.classList.remove('hidden');
  els.status.textContent = 'unlocked';
  renderList();
  newEntry();
}

// ====== Export / Import ======
function exportVault(){
  const raw = localStorage.getItem(storageKey(state.passHash));
  if(!raw){ alert('Nothing to export.'); return; }
  const blob = new Blob([raw], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `journal-${state.passHash.slice(0,8)}.encrypted.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function handleImport(file){
  const reader = new FileReader();
  reader.onload = async () => {
    try{
      const parsed = JSON.parse(reader.result);
      if(!parsed.salt || !parsed.payload){ throw new Error('Invalid file'); }
      // store under the *current* password's key after re-encrypting
      const password = els.pass.value;
      if(!password){ alert('Enter the password you want to use, then import again.'); return; }
      state.passHash = await sha256(password);
      salt = new Uint8Array(parsed.salt);
      state.key = await deriveKey(password, salt);
      // quick decrypt to validate password
      const test = await decryptJSON(state.key, parsed.payload);
      // re-save as-is under new storage key
      localStorage.setItem(storageKey(state.passHash), JSON.stringify(parsed));
      state.vault = test; afterUnlock();
    }catch(e){ alert('Import failed: ' + e.message); }
  };
  reader.readAsText(file);
}

// ====== Event wiring ======
els.enter.onclick = unlock;
els.pass.addEventListener('keydown',e=>{ if(e.key==='Enter') unlock(); });

els.save.onclick = async ()=>{
  const draft = currentDraft();
  if(openId){
    const e = state.vault.entries.find(x=>x.id===openId);
    Object.assign(e, draft);
    e.updatedAt = now();
  } else {
    state.vault.entries.unshift({ id: crypto.randomUUID(), createdAt: now(), updatedAt: now(), ...draft });
    openId = state.vault.entries[0].id;
  }
  await persist();
  renderList();
}

window.addEventListener('keydown', (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){
    e.preventDefault(); els.save.click();
  }
});

els.newBtn.onclick = newEntry;
els.search.oninput = renderList;
els.sort.onchange = renderList;

els.exportBtn.onclick = exportVault;
els.importFile.onchange = (e)=> e.target.files[0] && handleImport(e.target.files[0]);

els.logout.onclick = ()=>{ location.reload(); };
</script></body>
</html>